function PlayerLayout(){$(".player_wrap").each(function(){var $sizeH=$(window).outerHeight(),$sizeW=$(window).outerWidth(),$contH=$(this).find(".player_bar_cont").outerHeight(),$videoH=$(this).find("video").outerHeight(),$subTitleHeight=$(".video_subtitle").height()
$playerH=$sizeH-$contH-($(".video_subtitle").is(':visible')==true?$subTitleHeight:0),$paddingH=($playerH-$videoH)/2;var video_width,video_height;video_width=$playerH*16/9;video_height=$playerH;if(video_width>$sizeW){video_width=$sizeW;video_height=$sizeW*9/16;}
if(video_width<$sizeW){$(".player_cont .video").css("margin-left",($sizeW-video_width)/2);}else{$(".player_cont .video").css("margin-left",0);}
$(this).find(".player_cont .video").css({"width":video_width,"height":video_height});$(".player_cont").css('margin-top',($playerH/2)-(video_height/2)+'px');$(".litteFoxplayer").css({"width":$sizeW,"height":$sizeH})});}
function subtitle_flowtype(){$(".video_subtitle p.type1").flowtype({minimum:320,maximum:9999,minFont:12,maxFont:38,fontRatio:40});$(".video_subtitle p.type2").flowtype({minimum:320,maximum:9999,minFont:12,maxFont:36,fontRatio:40});$(".video_subtitle p.type3").flowtype({minimum:320,maximum:9999,minFont:12,maxFont:34,fontRatio:50});}
$(window).resize(function(){PlayerLayout();});$(document).ready(function(){PlayerLayout();$(".player_link > a").hover(function(){$(this).find("span").toggleClass("hidden");});subtitle_flowtype();});var video_player_g;function player_h5(option){var video_player=null;var video_option=null;var video_target_num=0;var video_title_time=0;var video_main_length=0;var view_array;var supplement_time=0;player_load();$(document).on('VideoSubtitlePlayer.ready',"#video",function(e,item){if(!$(this).data('video_duration')){$(this).data('video_duration',$(this)[0].duration);}
var duration=Math.ceil($(this).data('video_duration')-video_title_time);var time_min=parseInt(duration/60);var time_sec=parseInt(duration%60);var time=(time_min<10?'0'+time_min:time_min)+':'+(time_sec<10?'0'+time_sec:time_sec);$(".time.total").html(time);$(".control.btn_play").trigger('click');$(".player_link a").hide();$.each(video_option.player_link,function(key,yn){if(video_option.type=='M'&&key!='mp3Download'&&key!='text'&&key!='paint')yn='N';if(yn!='N'){$(".player_link ."+key).show();}else{$(".player_link ."+key).hide();}})
if(!video_option.next_url){$(".btn_next").hide();}
video_main_length=video_option.play_time;view_array=new Array();});$(document).on("click",".paging a",function(){var startMilliseconds=$(this).attr('start_ms');var endMilliseconds=$(this).attr('end_ms');if(startMilliseconds){video_player.seeking(startMilliseconds/1000,'sec');video_player.play();if(parseInt($(this).attr('group_number'))<$(".paging a.num").length)
{video_player.setStopMilliSeconds(endMilliseconds);}}});$(document).on("click",".paging .prev",function(){var current_page=$(".paging .on").attr('group_number');var target_page=parseInt(current_page)-(current_page%5)-(current_page%5==0?5:0);$(".paging .num[group_number="+target_page+"]").trigger('click');});$(document).on("click",".paging .next",function(){var current_page=$(".paging .on").attr('group_number');var target_page=parseInt(current_page)+4;target_page=target_page-(target_page%5)+1;$(".paging .num[group_number="+target_page+"]").trigger('click');});$('.btn_speed label').on('click',function(){var speed=$(this).find('span').text();var playbackrate=$(this).data('speed');$("input:radio[name='video-radio']:radio[value='"+playbackrate+"']").prop('checked',true);$('.icon-box span').text(speed);if(playbackrate){video_player.playbackrate(playbackrate);$('.choose-box').hide();}});$(document).on('click','#subtitle_toggle_btn',function(){$("#subtitle").toggle();})
$(document).on('VideoSubtitlePlayer.subTitleChange',"#video",function(e,item){var current_page=$(".paging .num.on").attr('group_number');if(item.group_number==0)item.group_number=1;if(current_page!=item.group_number){$(".paging .num.on").removeClass('on');$(".paging .num").hide();$(".paging .num[group_number="+item.group_number+"]").addClass('on');var view_page_s=parseInt((item.group_number-1)/5)*5+1;var view_page_e=view_page_s+5;for(var i=view_page_s;i<view_page_e;i++){$(".paging .num[group_number="+i+"]").show();}
if(view_page_s==1){$(".paging .prev").hide();}else{$(".paging .prev").show();}
var last_page=$(".paging .num").last().attr('group_number');if(view_page_e-1>=parseInt(last_page)){$(".paging .next").hide();}else{$(".paging .next").show();}}
subtitle_flowtype();});var old_currentTime=-1;var ended_check_cnt=0;$(document).on('VideoSubtitlePlayer.progress',"#video",function(e){var prev_time=video_option.prev_time?video_option.prev_time:30;if($(this)[0].currentTime>video_title_time&&$(".player_bar_cont .title").is(":visible")){$("#subtitle").show();$(".btn_skip").hide();$(".player_bar_cont .title").hide();$(".player_bar_cont .main").show();$(".player_cont .main").show();if(option.login_yn!=true&&video_option.charge!='F')$(".prev_timer").show();$("#video").trigger('VideoSubtitlePlayer.subTitleChange',{group_number:0});if(Cookie.get("PlayerH5_subtitle_view")=='Y'&&video_option.type=='S'&&$(".btn_subtitle").is(':visible')){$(".btn_subtitle").trigger("click");}
PlayerLayout();}else{}
if(option.login_yn!=true&&video_option.charge!='F'){var p_currentTime=$(this)[0].currentTime-video_title_time;if(p_currentTime>prev_time){setTimeout(function(){video_player.pause();video_player.mute(true);$(".btn_subtitle ").hide();$(".prev_timer").hide();$(".player_control").find("*").hide();$(".preview_layer").show();$(".player_wrap").remove();$(".player_wrap").find("*").off();},100);}else{var left_time=Math.ceil(prev_time-p_currentTime);$(".prev_timer span").text(left_time);$(".btn_wordbook").removeClass("show");}}
if($(this)[0].currentTime>$(this)[0].duration-supplement_time&&$(".player_link.layer_end").css('display')!='block')
{if(option.relay){video_target_num++;if(video_target_num>=option.video.length)video_target_num=0;$(".player_bar_cont .main").hide();$(".player_cont .main").hide();$(".player_bar_cont .title").show();if(video_option.type=='S')$(".btn_skip").show();else $(".btn_skip").hide();player_load();}else{$(".video_subtitle").hide();$(".layer_end").show();setTimeout(function(){$(".btn_play").hide();$(".btn_pause").hide();$(".btn_replay").show();},100)
PlayerLayout();}}
if($(this)[0].currentTime<=$(this)[0].duration-supplement_time){if($(".layer_end").is(':visible'))
{$(".layer_end").hide();$(".btn_pause").show();$(".btn_play").hide();$(".btn_replay").hide();PlayerLayout();}}
var now_time=parseInt($(this)[0].currentTime);if(now_time>video_title_time&&video_main_length>0&&video_player.play_status=='playing')
{if(view_array.indexOf(now_time)<0)
{view_array.push(now_time);if(view_array.length>=video_main_length*0.8)
{var param={play_time:view_array.length,type:option.relay?(video_option.type=='S'?'A':'B'):(video_option.type=='S'?'M':'S'),vtype:'N'};$.post(ROOT_PATH+"/player_h5/record/"+video_option.fc_id,param,function(data){if(typeof(opener.classPageReload)!="undefined"&&typeof(opener.classPageReload)=="function"&&data.class_log_count>0){opener.parent.classPageReload();}},'json');video_main_length=0;}}}
if(old_currentTime==$(this)[0].currentTime){ended_check_cnt++;if(ended_check_cnt>100)$(this).trigger('ended');}else{ended_check_cnt=0;old_currentTime=$(this)[0].currentTime;}
if(video_player.getPlaybackrate()!=0.74&&video_player.getPlaybackrate()!=0.85&&video_player.getPlaybackrate()!=1&&video_player.getPlaybackrate()!=1.15&&video_player.getPlaybackrate()!=1.3){setPlaybackrate();}});$(document).on('click','.btn_skip',function(){video_player.seeking(video_title_time,'sec');video_player.play();});$(document).on('click','.btn_subtitle, .btn_subtitle_on',function(){if($(".video_subtitle").is(':visible')){$(".video_subtitle").hide().addClass('view-h');$(this).removeClass('btn_subtitle_on').addClass('btn_subtitle');PlayerLayout();Cookie.del("PlayerH5_subtitle_view");}else{$(".video_subtitle").show().removeClass('view-h');$(this).removeClass('btn_subtitle').addClass('btn_subtitle_on');PlayerLayout();subtitle_flowtype();Cookie.set("PlayerH5_subtitle_view","Y",365);}
PlayerLayout();});$(document).on('click','.btn_replay',function(){view_array=new Array();video_main_length=video_option.play_time;video_player.replay();});$(document).on('click','.btn_next',function(){if(video_option.next_url){var h5_info=JSON.parse(base64_decode(Cookie.get('h5play_info')));var playback=1;if(video_option.type=="S"){playback=$('input[name="video-radio"]:checked').val();}
Cookie.set('h5play_info',base64_encode(JSON.stringify({'fc_ids':video_option.next_url,'w':h5_info.w,'h':h5_info.h,'next_yn':'Y','playback':playback})));location.reload();}})
$(document).on('click','.btn_wordbook',function(){Vocabulary(video_option.fc_id,video_option.charge);});$(document).on('click','.btn_close',function(){self.close();})
$(document).on('click','.btn_sound_off, .btn_sound_on, .sound_layer_btn',function(){if($(".btn_sound_off").is(':visible')){$(".btn_sound_off").hide();$(".btn_sound_on").show();$(".sound_layer").removeClass('show');video_player.mute(false);}else{$(".btn_sound_on").hide();$(".btn_sound_off").show();video_player.mute(true);}
PlayerLayout();});$(document).on('click','.player_link a',function(){var link=$(this).data('link');var free=video_option.charge=='F'?'Y':'N';switch(link){case"eBook":opener.parent.Supplement.eBook(video_option.fc_id,free,video_option.content_level);break;case"quiz":ViewQuiz(video_option.fc_id,video_option.charge=='F'?true:false);break;case"flashcards":FlashcardsNew(video_option.fc_id,free);break;case"crossword":Supplement.crossword(video_option.fc_id,free);break;case"starWords":var freeSw=video_option.player_link.starWords=='F'?'Y':'N';ViewSW(video_option.fc_id);break;case"recorder":var freeRe=video_option.player_link.recorder=='F'?'Y':'N';ViewRecord(video_option.fc_id);break;case"mp3Download":Supplement.mp3(video_option.fc_id,free);break;case"printAbleBook":PbPrint.open(video_option.fc_id,free);break;case"text":Supplement.org(video_option.fc_id,free);break;case"writing_topics":Supplement.topic(video_option.fc_id,free);break;case"flash_card":Supplement.flcard(video_option.fc_id,free);break;case"with_mom":Supplement.withmom(video_option.fc_id,free);break;case"topic":if(video_option.player_link.topic=='YF'||video_option.player_link.topic=='FF'){Supplement.sentence.file(video_option.fc_id,free);}else{Supplement.sentence.db(video_option.fc_id,free);}
break;case"tracing":Supplement.tr(video_option.fc_id,free);break;case"worksheet":Supplement.worksheet(video_option.fc_id,free);break;case"paint":Supplement.paint(video_option.fc_id,free);break;}})
$(document).on("VideoSubtitlePlayer.status","#video",function(e,status){ended_check_cnt=0;if(status=='ended'){console.log('Trinh Van Hung oi da end!');window.location.href="/player.html";var duration=Math.ceil($(this).data('video_duration')-video_title_time);var time_min=parseInt(duration/60);var time_sec=parseInt(duration%60);var time=(time_min<10?'0'+time_min:time_min)+':'+(time_sec<10?'0'+time_sec:time_sec);$("#play-duration").html(time);}else if(status=='playing'){if($(".video_subtitle.view-h").length>0){$(".video_subtitle").hide();}else{$(".video_subtitle").show();}
$(".layer_end").hide();if(!$(".btn_replay").is(":visible"))$(".btn_play").show();$(".btn_replay").hide();}
PlayerLayout();subtitle_flowtype();})
function player_load(){$("#video").attr('src',null);if(video_player){video_player.interval_stop();delete video_player;}
video_option=option.video[video_target_num];video_title_time=video_option.title_time;supplement_time=(video_option.type=='S'?(video_option.play_subtime?video_option.play_subtime:6.466):0.5)
if(video_option.type=='S')$(".btn_skip").show();else $(".btn_skip").hide();video_player=new VideoSubtitlePlayer({video_url:video_option.video_url,subtitle_url:video_option.subtitle,title_time:video_title_time,content_level:video_option.content_level,video_id:"#video",subtitle_id:"#subtitle",onChangeStatus:null,video_type:video_option.type});video_player_g=video_player;if(video_option.type=='S'){subtitle_check(video_player);$(".btn_subtitle").show();if(video_option.content_level=='LV08'||video_option.content_level=='LV09'||video_option.fc_id=='C0006111'||video_option.fc_id=='C0006138'||video_option.fc_id=='C0005131'||video_option.fs_id=='FS0070'||video_option.fs_id=='FS0024'||video_option.fs_id=='FS0071'||video_option.fs_id=='FS0074'||video_option.fs_id=='FS0111'||video_option.fs_id=='FS0112')
{if(video_option.fs_id=='FS0109'){}else{$(".btn_subtitle").hide();}}}else{$(".video_subtitle").hide();$(".btn_wordbook").hide();$(".btn_subtitle").hide();}
VideoControl(video_player,{stream:".time_area",stream_track_bar:".time_area .time_bg .timebar_state",stream_btn:null,play_btn:".control.btn_play",pause_btn:".control.btn_pause",play_duration:"#play-duration",fullscreen_btn:".control.btn_fullscreen",landscape_fullscreen:true,seeking_enalbe:!option.relay});if(video_option.type=="S"){setPlaybackrate()};video_player.play()}
function setPlaybackrate()
{var playback=1;var playback_text=1;var h5_info=JSON.parse(base64_decode(Cookie.get('h5play_info')));if($('input[name="video-radio"]:checked').val()){playback=$('input[name="video-radio"]:checked').val();}
if(h5_info.playback){playback=h5_info.playback;}
playback_text=playback;if(playback=="0.74"){playback_text=0.7;}
video_player.playbackrate(playback);$("input:radio[name='intro-radio']:input[value='"+playback+"']").prop("checked",true);$("input:radio[name='video-radio']:input[value='"+playback+"']").prop("checked",true);$('#intro-speed-text').html(playback_text+"x");$('#video-speed-text').html(playback_text+"x");}
function subtitle_check(video_player){if(option.relay!=true){var subtitle_data=video_player.getSubtitleData();$(".paging").html('');if(subtitle_data.length>0){$(".paging").append('<a class="prev" style="display:none"><span class="hidden">prev</span></a>');var start_ms=0;$.each(subtitle_data,function(i,item){var text=item.text;text=text.replace(/\n/g,'');text=text.replace(/\[@/g,'');text=text.replace(/@\]/g,'');text=text.replace(/\[i@/g,'');text=text.replace(/@i\]/g,'');if(item.group_number==1&&item.word_idx==1){start_ms=item.startMilliseconds-3000;if(start_ms<video_title_time*1000)start_ms=video_title_time*1000;}else if(item.word_idx==0&&text!=''){start_ms=item.startMilliseconds;}
if(text.substring(0,3)=='[s@'){start_ms=item.startMilliseconds;}
if(item.word_position=='last'||text.substring(0,3)=='[e@'){$(".paging").append('<a  class="num" group_number="'+item.group_number+'" start_ms="'+start_ms+'" end_ms="'+item.endMilliseconds+'" style="display:none">'+item.group_number+'</a>');}})
$(".paging").append('<a class="next" style="display:none" ><span class="hidden">next</span></a>');}else{setTimeout(function(){subtitle_check(video_player);},500)}}}};