VideoSubtitlePlayer=function(option){var options={video_url:null,subtitle_url:null,title_time:0,content_level:null,video_id:"#video",subtitle_id:"#subtitle",interval_time:1000,onProgress:null,onChangeStatus:null,subtitle_ani_yn:false,video_type:null};this.play_status='ready';var $video_object;var hls;var interval=null;var subtitle_interval=null;var subtitle_data=[];var subtitle_data_ori=[];var pre_endMilliseconds=0;var me=this;var _subtitle_interval;var cdnUrl=PLAYER_CDN_HOST;var stopMilliSeconds=null;this.init=function(option){if(option){options=Object.assign(options,option);$video_object=$(options.video_id);}
if(!$video_object[0].src){if(options.video_url.indexOf('.m3u8')>0){if(options.video_url.substring(0,2)!='//'&&options.video_url.substring(0,4)!='http'){options.video_url=cdnUrl+options.video_url;}
console.log("play issupported",Hls.isSupported());if(Hls.isSupported()){hls=new Hls();hls.loadSource(options.video_url);hls.attachMedia($video_object[0]);}else{if($video_object[0].canPlayType('application/vnd.apple.mpegurl'))
{$video_object[0].src=options.video_url;}else{alert('HLS영상 재생을 지원하지 않는 브라우져입니다. IE11, Edge, 크롬, 사파리 이상 지원합니다.');}}}else{if(options.video_url.substring(0,4)!='http')options.video_url=cdnUrl+options.video_url;console.log(options.video_url);$video_object.attr('src',options.video_url);}
$video_object.off('loadedmetadata').on('loadedmetadata',function(){$(options.video_id).trigger('VideoSubtitlePlayer.ready');});if(options.subtitle_url){_subtitle_load_xml();}}}
this.getOptions=function(){return options;}
this.play=function(){if(this.play_status!='playing'){_playing();}}
this.pause=function(){if(this.play_status=='playing'){$video_object.trigger('pause');_change_status('pause');_interval_stop();}else{_onProgress_call();}}
this.stop=function(){if(this.play_status=='playing'){$video_object.trigger('pause');_change_status('stop');_interval_stop();_onProgress_call();_change_status('ended');}}
this.seeking=function(perorsec,seeking_mode){var sec=0;if(seeking_mode=='percent')sec=perorsec/100*($video_object[0].duration-options.title_time)+options.title_time;else sec=perorsec;var seekable=$video_object[0].seekable.start(0)<=sec&&$video_object[0].seekable.end(0)>sec;if(seekable){$(options.subtitle_id).show();this.pause();$video_object[0].currentTime=sec;this.play();if(subtitle_data_ori.length>0){if(sec*1000>subtitle_data_ori[subtitle_data_ori.length-1].endMilliseconds)
{var item={group_number:$(".paging .num:last").attr('group_number')};$("#video").trigger('VideoSubtitlePlayer.subTitleChange',item);$(options.subtitle_id).hide();}
pre_endMilliseconds=subtitle_data_ori[0].startMilliseconds-1;subtitle_data=subtitle_data_ori.slice();_subtitle_interval();_onProgress_call();}}}
this.replay=function(){console.log('replay');if(this.play_status==='ended'&&hls&&$video_object[0].buffered.length>0&&$video_object[0].buffered.start(0)>0){console.log('hls destroy and init');hls.destroy();$video_object.removeAttr('src');this.init(this.getOptions());$video_object.on('VideoSubtitlePlayer.ready',function(){$video_object[0].currentTime=options.title_time;})
return;}
this.stop();this.seeking(options.title_time,'sec');var playback=1;if(options.video_type=="S"){playback=$('input[name="video-radio"]:checked').val();}
this.playbackrate(playback);}
this.playbackrate=function(playbackrate){$video_object[0].playbackRate=playbackrate;}
this.getPlaybackrate=function(){return $video_object[0].playbackRate;}
this.getSubtitleData=function(){return subtitle_data_ori;}
this.setStopMilliSeconds=function(stop_ms){stopMilliSeconds=stop_ms;}
this.mute=function(yn)
{$video_object.prop('muted',yn)}
var _playing=function(){console.log($video_object[0]);console.log($video_object);var promise=$video_object[0].play();$.when(promise).then(function(){if(me.play_status!='pause'&&subtitle_data_ori.length>0){pre_endMilliseconds=subtitle_data_ori[0].startMilliseconds-1;subtitle_data=subtitle_data_ori.slice();}
_change_status('playing');_interval_stop();_interval_start();$video_object.off('ended').on('ended',function(){me.stop();});},function(){console.log('play error');});}
var _interval_start=function(){if(options.onProgress){_onProgress_call();if(interval)window.clearInterval(interval);interval=window.setInterval(function(){_onProgress_call();},options.interval_time);}
if(subtitle_interval)window.clearInterval(subtitle_interval);if(_subtitle_interval){subtitle_interval=window.setInterval(function(){_subtitle_interval();},1);}}
var _interval_stop=function(){_onProgress_call();if(interval)window.clearInterval(interval);if(subtitle_interval)window.clearInterval(subtitle_interval);}
this.interval_stop=function(){if(interval)window.clearInterval(interval);if(subtitle_interval)window.clearInterval(subtitle_interval);}
var _onProgress_call=function(){if(options.onProgress){options.onProgress($video_object[0]);}
$(options.video_id).trigger('VideoSubtitlePlayer.progress',$video_object[0]);}
var _change_status=function(status){me.play_status=status;$(options.video_id).trigger('VideoSubtitlePlayer.status',status);if(options.onChangeStatus){options.onChangeStatus(me.play_status);}}
var _subtitle_hide=function(d_time){setTimeout(function(){$(options.subtitle_id).html('');},d_time);}
var _subtitle_load_xml=function(){$.ajax({url:options.subtitle_url,dataType:'xml',success:function(data){subtitle_data_ori=[];subtitle_data=[];var old_text_s='';var old_endMilliseconds=0;var group_number=0;var g_str='';$(data).find('Paragraph').each(function(idx,item){var number=parseInt($(this).find('Number').text());var startMilliseconds=parseInt($(this).find('StartMilliseconds').text())+options.title_time*1000;var endMilliseconds=parseInt($(this).find('EndMilliseconds').text())+options.title_time*1000;var text=$(this).find('Text').text();if(text!="[caption_out@")
{var text_s=text.replace(/\[\@(.*?)\@\]/g,function(s,s1){return s1;});text_s=text_s.replace(/\[i\@(.*?)\@\i]/g,function(s,s1){return s1;});text_s=text_s.replace(/\[s@/g,'');text_s=text_s.replace(/\[e@/g,'');text_s=text_s.replace(/\[caption_out@/g,'');if(old_text_s!=text_s||old_endMilliseconds+10<startMilliseconds){word_idx=0;word_position='first';group_number++;if(subtitle_data_ori.length>0)subtitle_data_ori[subtitle_data_ori.length-1].word_position='last';}else{word_position='';}
if(text_s.substring(0,3)=="[g@"){var l_data=$(data).find('Paragraph');for(var ii=idx;ii<l_data.length;ii++){var str=$(l_data[ii]).find('Text').text();g_str+=str+"&nbsp;";if(str.substring(str.length-3)=="@g]"){break;}}}
if(g_str!='')text=g_str;subtitle_data_ori.push({number:number,word_idx:word_idx,group_number:group_number,word_position:word_position,startMilliseconds:startMilliseconds,endMilliseconds:endMilliseconds,text:text});word_idx++;old_text_s=text_s;old_endMilliseconds=endMilliseconds;if(text_s.substring(text_s.length-3)=="@g]"){g_str='';}}});if(subtitle_data_ori.length>0)subtitle_data_ori[subtitle_data_ori.length-1].word_position='last';_subtitle_interval=_subtitle_interval_xml;pre_endMilliseconds=subtitle_data_ori[0].startMilliseconds-1;subtitle_data=subtitle_data_ori.slice();if(subtitle_interval)window.clearInterval(subtitle_interval);subtitle_interval=window.setInterval(function(){_subtitle_interval();},1);},error:function(){$(".control.btn_subtitle").removeClass('show');}});options.subtitle_url=null;}
var _subtitle_interval_xml=function(){var play_current_time=parseInt($video_object[0].currentTime*1000);if(play_current_time>=subtitle_data_ori[subtitle_data_ori.length-1].endMilliseconds){window.clearInterval(subtitle_interval);$(options.subtitle_id).hide();}
if(subtitle_data.length==0){return;}
if(stopMilliSeconds!=null&&stopMilliSeconds<play_current_time){me.pause();stopMilliSeconds=null;}else if(pre_endMilliseconds<play_current_time){for(var i=0;i<subtitle_data.length;i++){var item=subtitle_data[i];var startMilliseconds=item.startMilliseconds;var endMilliseconds=item.endMilliseconds;if(parseInt(play_current_time)>parseInt(endMilliseconds)){subtitle_data.shift();}else if(play_current_time>=startMilliseconds&&play_current_time<=endMilliseconds){var subtitle_text=item.text;subtitle_text=subtitle_text.replace(/ /g,'&nbsp;');subtitle_text=subtitle_text.replace(/\[g@/g,'');subtitle_text=subtitle_text.replace(/@g\]/g,'');subtitle_text=subtitle_text.replace(/\[s@/g,'');subtitle_text=subtitle_text.replace(/\[e@/g,'');subtitle_text=subtitle_text.replace(/\[i\@(.*?)\@\i]/g,function(s,s1){return"<i>"+s1+"</i>";});subtitle_text=subtitle_text.replace(/\[n@/g,'<BR>');subtitle_text=subtitle_text.replace(/\[n3@/g,'<BR>&nbsp;&nbsp;&nbsp;');subtitle_text=subtitle_text.replace(/\[s@/g,'');var font_size="type3";var br_count=(subtitle_text.split('<BR>')).length-1;if(options.content_level<='LV03'&&br_count<=0){font_size="type1";}else if(options.content_level<='LV03'&&br_count>0){font_size="type2";}
if(item.word_position!='last'){subtitle_text=subtitle_text.replace(/(.*?)\[\@(.*?)\@\]/g,function(s,s1,s2){return"<span class='on'>"+s1+"</span><span class='word'>"+s2+"<span class='on'>"+s2+"</span></span>";});subtitle_text="<p class='"+font_size+"'>"+subtitle_text.replace(/\n/g,"</p><p class='spell'>")+"</p>";}else{subtitle_text="<span class='on'>"+subtitle_text+"</span>";subtitle_text="<p class='"+font_size+"'>"+subtitle_text.replace(/\n/g,"</p><p class='spell'>")+"</p>";}
subtitle_text=subtitle_text.replace(/"/g,'<span class="quotes">&quot;</span>');subtitle_text=subtitle_text.replace(/“/g,'<span class="quotes">“</span>');subtitle_text=subtitle_text.replace(/”/g,'<span class="quotes">”</span>');if(subtitle_text.indexOf("[caption_out@")>=0){$(options.subtitle_id).hide();}
$(options.subtitle_id).html(subtitle_text);var d_time=(endMilliseconds-play_current_time)/$video_object[0].playbackRate;var ii=i+1;if(ii<subtitle_data.length){if(subtitle_data[ii].startMilliseconds>(endMilliseconds+10)){_subtitle_hide(d_time);}}
$(options.video_id).trigger('VideoSubtitlePlayer.subTitleChange',item);subtitle_data.shift();pre_endMilliseconds=endMilliseconds;return;}}}}
if(option)this.init(option);}
if(typeof Object.assign!='function'){Object.defineProperty(Object,"assign",{value:function assign(target,varArgs){'use strict';if(target==null){throw new TypeError('Cannot convert undefined or null to object');}
var to=Object(target);for(var index=1;index<arguments.length;index++){var nextSource=arguments[index];if(nextSource!=null){for(var nextKey in nextSource){if(Object.prototype.hasOwnProperty.call(nextSource,nextKey)){to[nextKey]=nextSource[nextKey];}}}}
return to;},writable:true,configurable:true});}