<!-- index.html -->
<!DOCTYPE html>
<html>

<head>
    <title>Master Page</title>
    <link rel="stylesheet" type="text/css" href="style.css">
    <title>Sector Chart</title>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <!-- <script src="https://cdn.datatables.net/scroller/2.3.0/js/dataTables.scroller.min.js"></script> -->
    <script src="https://cdn.datatables.net/keytable/2.11.0/js/dataTables.keyTable.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.18.1/moment.min.js"></script>

    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/scroller/2.3.0/css/scroller.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/keytable/2.11.0/css/keyTable.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">


    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
        integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>

    <link rel="stylesheet" type="text/css" href="tooltipster.bundle.min.css">
    <script type="text/javascript" charset="utf8" src="tooltipster.bundle.min.js"></script>

    <style>
        div.dataTables_wrapper div.dataTables_info {
            padding-top: 0px;
        }

        div.dataTables_wrapper div.dataTables_info {
            font-size: 6px;
            /* Set font size for information text (e.g., "Showing 1 to 10 of 100 entries") */
        }

        table {
            border-collapse: collapse;
            width: 100%;
        }

        table,
        th,
        td {
            border: 1px solid #ccc;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }
    </style>
    <style>
        /* CSS for limiting the number of rows and adding a vertical scroll */
        #timelineContainer {
            max-height: 600px;
            /* Set the maximum height for the table */
            overflow-y: auto;
            /* Enable vertical scrolling */
        }
    </style>
    <style>
        /* CSS for enabling both horizontal and vertical scrolling for the entire page */
        body,
        html {
            overflow: scroll;
            /* Enable both horizontal and vertical scrolling for the entire page */
        }
    </style>
    <style>
        /* #chartcontainer {
            text-align: center;
        }

        #vnindex,#busd {
            display: inline;
        } */
        #chartcontainer {
            display: flex;
            justify-content: center;
        }

        #combineDiv {
            display: flex;
            /* flex-wrap: wrap; */
            /* Cho phép các ô chuyển hàng khi không đủ không gian */
            /* justify-content: center; */
        }

        .hidden-element {
            display: none;
        }

        .grid-container {
            display: grid;
            grid-template-columns: repeat(3, 700px);
            /* 3 cột trong mỗi hàng */
            grid-gap: 10px;
            /* Khoảng cách giữa các ô */
            /* grid-auto-rows: 300px; */
        }

        .grid-item {
            /* Định dạng cho mỗi ô trong grid */
            border: 1px solid #ddd;
            padding: 10px;
            width: 700px;
            /* Chiều rộng của mỗi ô */
            height: 700px;
            /* Chiều cao của mỗi ô */
        }

        .flex-container {
            display: flex;
            flex-wrap: wrap;
            /* Cho phép các ô chuyển hàng khi không đủ không gian */
            justify-content: center;
        }

        .flex-item3 {
            flex: 0 0 calc(33.33% - 20px);
            /* 33.33% chiều rộng mỗi ô, trừ đi khoảng cách giữa các ô */
            box-sizing: border-box;
            /* Đảm bảo padding và border không làm tăng kích thước thực tế của ô */
            margin: 10px;
            /* Khoảng cách giữa các ô */
        }

        .flex-item2 {
            flex: 0 0 calc(50% - 20px);
            /* 33.33% chiều rộng mỗi ô, trừ đi khoảng cách giữa các ô */
            box-sizing: border-box;
            /* Đảm bảo padding và border không làm tăng kích thước thực tế của ô */
            margin: 10px;
            /* Khoảng cách giữa các ô */
        }

        .flex-item1 {
            flex: 0 0 calc(100% - 20px);
            /* 33.33% chiều rộng mỗi ô, trừ đi khoảng cách giữa các ô */
            box-sizing: border-box;
            /* Đảm bảo padding và border không làm tăng kích thước thực tế của ô */
            margin: 10px;
            /* Khoảng cách giữa các ô */
        }

        .flex-itemOne {
            flex: 0 0 calc(80% - 20px);
            /* 33.33% chiều rộng mỗi ô, trừ đi khoảng cách giữa các ô */
            box-sizing: border-box;
            /* Đảm bảo padding và border không làm tăng kích thước thực tế của ô */
            margin: 10px;
            /* Khoảng cách giữa các ô */
        }

        .custom-link {
            text-decoration: none !important;
        }

        /* .tooltip {
            position: absolute;
            z-index: 1;
            background-color: #f9f9f9;
            border: 1px solid #ccc;
            padding: 5px;
            border-radius: 5px;
            display: none;
        } */

        .tooltipContainer {
            overflow: hidden;
            position: relative;
            display: inline-block;
            border: 2px solid #007bff;
            /* Đường viền màu xanh */
            border-radius: 10px;
            /* Bo tròn */
            padding: 0px;
            background-color: FloralWhite;
        }

        .tooltipHeader {
            position: relative;
            display: inline-block;
            border: 2px solid #007bff;
            /* Đường viền màu xanh */
            border-radius: 10px;
            /* Bo tròn */
            padding: 10px;
        }

        .custom-theme {
            background-color: #8a2be2;
            /* Purple background color */
            color: #fff;
            /* White text color */
            border-radius: 5px;
            /* Rounded corners */
        }

        .my-custom-theme {
            border-radius: none;
            border: none;
            background: rgba(0, 0, 0, 0);
            color: #000;
            border-color: rgba(0, 0, 0, 0);
        }

        /* Use this next selector to style things like font-size and line-height: */
        .my-custom-theme .tooltipster-content {
            font-family: Arial, sans-serif;
            font-size: 14px;
            line-height: 16px;
            padding: 8px 10px;
            background: lightyellow;
            color: #111010;
            border-radius: none;
            border: none;
        }

        .scrollable-div {
            width: 100%;
            /* Set the width as needed */
            /* max-height: 700px; */
            /* height: 700px; */
            /* Set the height as needed */
            overflow: auto;
            /* Enable scrolling */
            border: 1px solid #ccc;
            /* Optional: Add a border for better visibility */
        }

        .container-div {
            width: 100%;
            /* Set the width as needed */
            /* Set the height as needed */
            overflow: auto;
            /* Enable scrolling */
            border: 1px solid #ccc;
            /* Optional: Add a border for better visibility */
            /* position: relative; */
            /* Add position property */
            z-index: 2;
            /* Add higher z-index */
        }

        .master-div {
            width: 100%;
            /* Set the width as needed */
            /* height: 800px; */
            max-height: 800px;
            /* Set the height as needed */
            overflow: auto;
            /* Enable scrolling */
            border: 1px solid #ccc;
            /* Optional: Add a border for better visibility */
            /* position: relative; */
            /* Add position property */
            z-index: 2;
            /* Add higher z-index */
        }

        .title-div {
            margin-top: 20px;
            margin-bottom: 20px;
            width: 100%;
            /* position: fixed; */
            top: 0;
            left: 50%;
            /* transform: translateX(-50%);             */
            /* Set the width as needed */
            /* justify-content: center; */
            text-align: center;
            color: #ff7300;
            /* Set the height as needed */
            overflow: auto;
            /* Enable scrolling */
            /* border: 1px solid #ccc; */
            /* Optional: Add a border for better visibility */
            /* z-index: 999; */
        }


        .title-div span {
            font-size: 52px;
            font-weight: bold;
        }

        .sumDiv {
            width: 100%;
            /* Add styling for the AAA div */
            /* position: relative; */
            /* Add position property */
            /* z-index: 1; */
            /* Add lower z-index */
        }
    </style>
</head>

<body>
    <div class="sidebar">
        <button id="toggleSidebar">Toggle Sidebar</button>
        <div class="overlay" id="overlay"></div>
        <ul>
            <li><a href="/chart3" target="_blank">VNINDEX</a></li>
            <li><a href="/chart4" target="_blank">BySellSymbols</a></li>
            <li><a href="/sectors?interval=300" target="_blank">BuySellSectors</a></li>
            <li><a href="/sectorschart?percent=300" target="_blank">Sector Chart With Percent</a></li>
            <li><a href="/sectorschart" target="_blank">Sector Chart</a></li>
            <li><a href="/timeline?symbols=MSN" target="_blank">timeline</a></li>
            <li><a href="/timelinemulti?symbols=NVL,VCI,DXG,DIG,PDR,NLG" target="_blank">NVL,VCI,DXG,DIG,PDR,NLG</a>
            <li><a href="/?statDay=1" target="_self">Investor 1 day</a>
            <li><a href="/?statDay=3" target="_self">Investor 3 day</a>
            <li><a href="/?statDay=7" target="_self">Investor 7 day</a>
            <li><a href="/?statDay=10" target="_self">Investor 10 day</a>
            <li><a href="/?statDay=30" target="_self">Investor 30 day</a>
            <li><a href="/?statDay=100" target="_self">Investor max day</a>
            </li>
            <!-- Add links for other charts -->
        </ul>
    </div>
    <div class="container-div">
        <div class="master-div">

            <div class="title-div">
                <span style="font-size: 52px; font-weight: bold;">Thống kê giao dịch theo tổ chức</span>
            </div>

            <table cellpadding="3" cellspacing="0" border="0" style="width: 67%; margin: 0 auto 2em auto;">
                <thead>
                    <tr>
                        <th>Target</th>
                        <th>Search text</th>
                        <th>Treat as regex</th>
                        <th>Use smart search</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="filter_global">
                        <td>Global search</td>
                        <td align="center"><input type="text" class="global_filter" id="global_filter"></td>
                        <td align="center"><input type="checkbox" class="global_filter" id="global_regex"></td>
                        <td align="center"><input type="checkbox" class="global_filter" id="global_smart"
                                checked="checked"></td>
                    </tr>
                    <tr id="filter_col1" data-column="0">
                        <td>Column - Code</td>
                        <td align="center"><input type="text" class="column_filter" id="col0_filter"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col0_regex"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col0_smart"
                                checked="checked"></td>
                    </tr>
                    <!-- <tr id="filter_col2" data-column="1">
                        <td>Column - trading_date</td>
                        <td align="center"><input type="text" class="column_filter" id="col1_filter"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col1_regex"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col1_smart"
                                checked="checked"></td>
                    </tr> -->
                    <!-- <tr id="filter_col3" data-column="2">
                        <td>Column - Office</td>
                        <td align="center"><input type="text" class="column_filter" id="col2_filter"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col2_regex"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col2_smart"
                                checked="checked"></td>
                    </tr>
                    <tr id="filter_col4" data-column="3">
                        <td>Column - Age</td>
                        <td align="center"><input type="text" class="column_filter" id="col3_filter"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col3_regex"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col3_smart"
                                checked="checked"></td>
                    </tr>
                    <tr id="filter_col5" data-column="4">
                        <td>Column - Start date</td>
                        <td align="center"><input type="text" class="column_filter" id="col4_filter"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col4_regex"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col4_smart"
                                checked="checked"></td>
                    </tr>
                    <tr id="filter_col6" data-column="5">
                        <td>Column - Salary</td>
                        <td align="center"><input type="text" class="column_filter" id="col5_filter"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col5_regex"></td>
                        <td align="center"><input type="checkbox" class="column_filter" id="col5_smart"
                                checked="checked"></td>
                    </tr> -->
                </tbody>
            </table>

            <table cellpadding="3" cellspacing="0" border="0" style="width: 67%; margin: 0 auto 2em auto;">
                <thead>
                    <tr>
                        <th>Target</th>
                        <th>Range Search</th>
                        <th>From</th>
                        <th>To</th>
                    </tr>
                </thead>
                <tbody>
                    <tr id="filter_global">
                        <td>Global search</td>
                        <td align="center">
                            <form action="#" method="post">
                                <!-- <label for="dropdown">Select an option:</label> -->
                                <select id="dropdown" name="dropdown">
                                    <option value="option1">Option 1</option>
                                    <option value="option2">Option 2</option>
                                    <option value="option3">Option 3</option>
                                    <option value="option4">Option 4</option>
                                </select>

                                <!-- <input type="submit" value="Submit"> -->
                            </form>
                        </td>

                        <td align="center"><input type="text" class="global_filter1" id="global_from"></td>
                        <td align="center"><input type="text" class="global_filter1" id="global_to"></td>
                    </tr>
                    <tr id="filter_code" data-column="0">
                        <td>Column - Code</td>
                        <td align="center"><input type="text" class="column_filter1" id="code_filter"></td>
                    </tr>
                    <tr id="filter_col2" data-column="1">
                        <td>Column - trading_date</td>
                        <td align="center"><input type="date" class="column_filter1" id="td_filter"></td>
                        <td align="center"><input type="date" class="column_filter1" id="td_from"></td>
                        <td align="center"><input type="date" class="column_filter1" id="td_to"></td>
                    </tr>

                </tbody>
            </table>
            <div class="title-div">
                <button onclick="clearCache()">Clear Cache</button>
                <button onclick="search()" style="margin-left: 30px; width: 90px;">Search</button>
            </div>
            <div>
                <table id="myTable" class="display">
                    <thead id="headTable">
                        <tr>
                            <th>Sector</th>
                            <th>Thời gian</th>
                            <th>Mã Trần</th>
                            <th>Mã Tăng</th>
                            <th>Mã Đứng Giá</th>
                            <th>Mã Giảm</th>
                            <th>Mã Sàn</th>
                        </tr>
                    </thead>
                    <!-- <tfoot id="footTable">
                    <tr>
                        <th>Thống kê</th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                        <th></th>
                    </tr>
                </tfoot> -->
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm ở đây -->
                    </tbody>

                </table>
            </div>



        </div>
        <br />
        <div class="sumDiv">

            <div id="buttonManager">
                <span style="font-size: 24px; font-weight: bold;">10:VNINDEX 11:VN30</span>
            </div>
            <div>
                <table id="sumTable" class="display">
                    <thead id="headSumTable">
                        <tr>
                            <th>Sector</th>
                            <th>Thời gian</th>
                            <th>Mã Trần</th>
                            <th>Mã Tăng</th>
                            <th>Mã Đứng Giá</th>
                            <th>Mã Giảm</th>
                            <th>Mã Sàn</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Dữ liệu sẽ được thêm ở đây -->
                    </tbody>

                </table>
            </div>
        </div>
    </div>
    <script>
        async function search() {
            let searchField = $('#dropdown').val()
            let globalFrom = $('#global_from').val()
            let globalTo = $('#global_to').val()
            let codeFilter = $('#code_filter').val()
            let td = $('#td_filter').val()
            let td_from = $('#td_from').val()
            let td_to = $('#td_to').val()
            if (searchField.length == 0 && codeFilter.length == 0 && td.length == 0 && td_from.length == 0 && td_to.length == 0) return

            filterData = investorDataNew.filter(e => {
                var val = true;
                if (searchField.length > 0) {
                    if (globalFrom.length > 0) val = val && (e[searchField] >= +globalFrom)
                    if (globalTo.length > 0) val = val && (e[searchField] <= +globalTo)
                }
                if (codeFilter.length > 0) val = val && (e['code'] == codeFilter)
                if (td.length > 0) val = val && (e['trading_date'] * 1000 == +moment(td, 'YYYY-MM-DD').format("x"))
                if (td_from.length > 0) val = val && (e['trading_date'] * 1000 >= +moment(td_from, 'YYYY-MM-DD').format("x"))
                if (td_to.length > 0) val = val && (e['trading_date'] * 1000 <= +moment(td_to, 'YYYY-MM-DD').format("x"))
                return val;
            })

            updateRawTable(filterData)
        }
        async function clearCache() {
            var a = await getAll()
            if (a) {
                a.forEach(e => { del(e.id) })
            }
        }

        function capitalizeFirstLetter(sentence) {
            return sentence.charAt(0).toUpperCase() + sentence.slice(1);
        }

        investorSelectField = {
            "close_value": "giá đóng cửa",
            // "total_delta": "delta tổng ",
            "foreign_delta": "delta khối ngoại",
            "proprietary_delta": "delta tự doanh",
            "local_individual_delta": "delta cá nhân(TN)",
            "local_institutional_delta": "delta tổ chức(TN)",
            "foreign_individual_delta": "delta cá nhân(NN)",
            "foreign_institutional_delta": "delta tổ chức(NN)",
            "total_buy": "tổng mua",
            "total_sell": "tổng bán",
            "total_buy_matched": "tổng mua khớp",
            "total_sell_matched": "tổng bán khớp",
            "foreign_buy_matched": "mua khối ngoại khớp",
            "foreign_sell_matched": "bán khối ngoại khớp",
            "foreign_buy": "mua khối ngoại",
            "foreign_sell": "bán khối ngoại",
            "proprietary_buy_matched": "mua tự doanh khớp",
            "proprietary_sell_matched": "bán tự doanh khớp",
            "proprietary_buy": "mua tự doanh",
            "proprietary_sell": "bán tự doanh",
            "local_individual_buy_matched": "mua cá nhân(TN) khớp",
            "local_individual_sell_matched": "bán cá nhân(TN) khớp",
            "local_individual_buy": "mua cá nhân(TN)",
            "local_individual_sell": "bán cá nhân(TN)",
            "local_institutional_buy_matched": "mua tổ chức(TN) khớp",
            "local_institutional_sell_matched": "bán tổ chức(TN) khớp",
            "local_institutional_buy": "mua tổ chức(TN)",
            "local_institutional_sell": "bán tổ chức(TN)",
            "foreign_individual_buy_matched": "mua cá nhân(NN) khớp",
            "foreign_individual_sell_matched": "bán cá nhân(NN) khớp",
            "foreign_individual_buy": "mua cá nhân(NN)",
            "foreign_individual_sell": "bán cá nhân(NN)",
            "foreign_institutional_buy_matched": "mua tổ chức(NN) khớp",
            "foreign_institutional_sell_matched": "bán tổ chức(NN) khớp",
            "foreign_institutional_buy": "mua tổ chức(NN)",
            "foreign_institutional_sell": "bán tổ chức(NN)"
        }

        let options = '<option value="">-- Select an option --</option>'
        Object.keys(investorSelectField).forEach(f => {
            investorSelectField[f] = capitalizeFirstLetter(investorSelectField[f])
            options += '<option value="' + f + '">' + investorSelectField[f] + '</option>'
        })
        $('#dropdown').html(options)

        investorFiled = { 'code': 'Mã', "trading_date": "Ngày giao dịch", ...investorSelectField }

        const url = new URL(window.location.href);
        const queryParams = url.searchParams;
        var date = queryParams.get('date');
        if (!date) date = '1,3,5,7,10,20,30,100'
        var statDay = queryParams.get('statDay');
        if (!statDay) statDay = 30
        else statDay = +statDay

        var limit = queryParams.get('limit');
        if (!limit) limit = 1000
        else limit = +limit
        console.log("limit", limit)
        let table;
        function filterGlobal(table) {
            let filter = document.querySelector('#global_filter');
            let regex = document.querySelector('#global_regex');
            let smart = document.querySelector('#global_smart');

            table.search(filter.value, regex.checked, smart.checked).draw();
        }

        function filterColumn(table, i) {
            let filter = document.querySelector('#col' + i + '_filter');
            let regex = document.querySelector('#col' + i + '_regex');
            let smart = document.querySelector('#col' + i + '_smart');

            table.column(i).search(filter.value, regex.checked, smart.checked).draw();
        }



        document.querySelectorAll('input.global_filter').forEach((el) => {
            el.addEventListener(el.type === 'text' ? 'keyup' : 'change', () =>
                filterGlobal(table)
            );
        });

        document.querySelectorAll('input.column_filter').forEach((el) => {
            let tr = el.closest('tr');
            let columnIndex = tr.getAttribute('data-column');

            el.addEventListener(el.type === 'text' ? 'keyup' : 'change', () =>
                filterColumn(table, columnIndex)
            );
        });

        function formatDate(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Tháng bắt đầu từ 0
            const year = date.getFullYear();

            return `${day}/${month}/${year}`;
        }
        function formatDate2(date) {
            const day = date.getDate().toString().padStart(2, '0');
            const month = (date.getMonth() + 1).toString().padStart(2, '0'); // Tháng bắt đầu từ 0
            const year = date.getFullYear();

            return `${day}/${month}`;
        }

        // let fields = [
        //     "code", "trading_date", "close_value", "foreign_buy_matched", "foreign_sell_matched", "foreign_buy", "foreign_sell", "proprietary_buy_matched", "proprietary_sell_matched", "proprietary_buy", "proprietary_sell", "local_individual_buy_matched", "local_individual_sell_matched", "local_individual_buy", "local_individual_sell", "local_institutional_buy_matched", "local_institutional_sell_matched", "local_institutional_buy", "local_institutional_sell", "foreign_individual_buy_matched", "foreign_individual_sell_matched", "foreign_individual_buy", "foreign_individual_sell", "foreign_institutional_buy_matched", "foreign_institutional_sell_matched", "foreign_institutional_buy", "foreign_institutional_sell"
        // ]
        let fields = [...Object.keys(investorFiled)]

        // $.fn.dataTable.ext.errMode = 'none';

        let additionalTranslations = {
            // "total_delta": "delta tổng ",
            "foreign_delta": "delta khối ngoại",
            "proprietary_delta": "delta tự doanh",
            "local_individual_delta": "delta cá nhân(TN)",
            "local_institutional_delta": "delta tổ chức(TN)",
            "foreign_individual_delta": "delta cá nhân(NN)",
            "foreign_institutional_delta": "delta tổ chức(NN)",
        };
        Object.keys(additionalTranslations).forEach(f => {
            additionalTranslations[f] = capitalizeFirstLetter(additionalTranslations[f])
        })

        investorFiled2 = { ...additionalTranslations, ...investorFiled }

        updateData = (response) => {
            response.sort((a, b) => { return b.trading_date - a.trading_date })
            sheet = processInvestor(response)
            updateRawTable = (data) => {
                if (!$.fn.DataTable.isDataTable('#myTable')) {
                    statsHead = document.querySelector('#headTable')
                    statsHead.innerHTML = ''
                    var theadRow = document.createElement('tr');
                    statsHead.appendChild(theadRow);
                    // let x0 = data[0]
                    fields.forEach(k => {
                        var th = document.createElement('th');
                        th.innerHTML = '<span>' + investorFiled[k] + '</span>'
                        theadRow.appendChild(th);
                    })
                    // console.table(response.slice(0,100))
                    $('#myTable').DataTable(
                        {
                            // "ajax": function (data, callback, settings) {
                            //     let out = [];
                            //     for (var i = data.start, ien = data.start + data.length; i < Math.min(ien, response.length); i++) {
                            //         out.push(response[i]);
                            //     }
                            //     callback({
                            //         draw: data.draw,
                            //         data: out,
                            //         recordsTotal: response.length,
                            //         recordsFiltered: response.length,
                            //     });
                            // },

                            fixedHeader: {
                                // header: true,
                                // footer: true
                            },
                            fixedColumns: {
                                left: 1,
                                left: 2,
                                // right: 1
                            },
                            columns: [
                                ...fields.map(e => { return { data: e, orderable: true, searchable: true } })
                            ],
                            columnDefs: [

                                {
                                    targets: 1,
                                    "width": "20%",
                                    render: function (data, type, row, meta) {
                                        if (type == 'display') {
                                            data = formatDate(new Date(data * 1000))
                                        }
                                        return data;
                                    }
                                },
                                {
                                    targets: Array.from({ length: 34 }, (_, index) => index + 3),
                                    render: function (data, type, row, meta) {
                                        if (type == 'display') {
                                            if (Number.isInteger(data)) {
                                                data = numeral(data).format('0,0')
                                            } else {
                                                data = numeral(data).format('0,0.00')
                                            }
                                        }
                                        return data
                                    }
                                },
                            ],
                            order: [[2, 'desc']],
                            processing: true,
                            ordering: true,
                            scroller: true,
                            // scrollY: 200,
                            searching: true,
                            // serverSide: true,
                            lengthMenu: [30, 50, 100, 200, 500, 2000],
                            dom: 'lBfrtip',
                            buttons: [
                                'copy',
                                'excel', 'pdf',
                                'colvis'
                            ]

                        }
                    );
                }
                table = $('#myTable').DataTable();
                table.clear();
                table.rows.add(data).draw()
            }
            updateRawTable(investorDataNew.slice(0, limit))

            // $('#myTable').DataTable({
            //     "ajax": function (data, callback, settings) {
            //         let out = [];
            //         for (var i = data.start, ien = data.start + data.length; i < ien; i++) {
            //             out.push(response[i]);
            //         }

            //         callback({
            //             draw: data.draw,
            //             data: out,
            //             recordsTotal: response.length,
            //             recordsFiltered: response.length,
            //         });
            //     }
            // });


            // console.table(response)
            updateSumTable = (data) => {
                let sumField = [
                    "code",
                    "trading_date",
                    // "total_delta",
                    "foreign_delta",
                    "proprietary_delta",
                    "local_individual_delta",
                    "local_institutional_delta",
                    "foreign_individual_delta",
                    "foreign_institutional_delta",
                    "total_buy_matched",
                    "total_sell_matched",
                    "foreign_buy_matched",
                    "foreign_sell_matched",
                    "proprietary_buy_matched",
                    "proprietary_sell_matched",
                    "local_individual_buy_matched",
                    "local_individual_sell_matched",
                    "local_institutional_buy_matched",
                    "local_institutional_sell_matched",
                    "foreign_individual_buy_matched",
                    "foreign_individual_sell_matched",
                    "foreign_institutional_buy_matched",
                    "foreign_institutional_sell_matched",
                ]

                statsHead = document.querySelector('#headSumTable')
                statsHead.innerHTML = ''
                var theadRow = document.createElement('tr');
                statsHead.appendChild(theadRow);

                sumField.forEach(k => {
                    var th = document.createElement('th');
                    th.innerHTML = '<span>' + investorFiled2[k] + '</span>'
                    theadRow.appendChild(th);
                })

                $('#sumTable').DataTable(
                    {
                        fixedHeader: {
                            // header: true,
                            // footer: true
                        },
                        fixedColumns: {
                            left: 1,
                            left: 2,
                            // right: 1
                        },
                        columns: [
                            ...sumField.map(e => { return { data: e, orderable: true, searchable: true } })
                        ],
                        columnDefs: [

                            {
                                targets: 1,
                                "width": "5%",
                                render: function (data, type, row, meta) {
                                    if (type == 'display') {
                                        data = formatDate(new Date(data * 1000))
                                    }
                                    return data;
                                }
                            },
                            {
                                targets: Array.from({ length: 20 }, (_, index) => index + 2),
                                render: function (data, type, row, meta) {
                                    if (type == 'display') {
                                        if (Number.isInteger(data)) {
                                            data = numeral(data).format('0,0')
                                        } else {
                                            data = numeral(data).format('0,0.00')
                                        }
                                    }
                                    return data
                                }
                            },
                        ],
                        order: [[2, 'desc']],
                        processing: true,
                        ordering: true,
                        scroller: true,
                        // scrollY: 200,
                        searching: true,
                        // serverSide: true,
                        lengthMenu: [30, 50, 100, 200, 500, 2000],
                        dom: 'lBfrtip',
                        buttons: [
                            'copy',
                            'excel', 'pdf',
                            'colvis'
                        ]

                    }
                );

                var table2 = $('#sumTable').DataTable();
                table2.clear();
                table2.rows.add(data).draw()
            }
            updateSumTable(sheet[statDay])
        }
        var investorDataStore;

        function updateDataTable(data) {
            if (!data) {
                $.ajax({
                    url: `/api/investordata`,
                    method: 'GET',
                    success: function (response) {
                        add({ id: formatDate(new Date()), data: response }) //Add indexedDb
                        investorDataStore = response;
                        updateData(response)
                    },
                    error: function (error) {
                        console.error('Error fetching updated data:', error);
                    }
                });
            } else {
                updateData(data)
            }

        }


        // Example of using IndexedDB

        let db;

        initDb = () => {
            return new Promise((res, rej) => {
                var request = indexedDB.open("investor", 1);
                request.onupgradeneeded = function (event) {
                    db = event.target.result;
                    var objectStore = db.createObjectStore("investor", { keyPath: "id" });
                    res(db)
                };
                request.onsuccess = function (event) {
                    db = event.target.result;
                    res(db)
                };
            })
        }

        var dbPromise = initDb()

        add = (data) => {
            var transaction = db.transaction(["investor"], "readwrite");
            var objectStore = transaction.objectStore("investor");
            // Add data

            return new Promise((res, rej) => {
                var req = objectStore.add(data);
                req.onsuccess = (e) => {
                    res(e.target.result)
                }
                req.onerror = (e) => {
                    rej(e.target.error)
                }
            })
        }

        get = (id) => {
            var transaction = db.transaction(["investor"], "readwrite");
            var objectStore = transaction.objectStore("investor");
            return new Promise((res, rej) => {
                var req = objectStore.get(id)
                req.onsuccess = (e) => {
                    res(e.target.result)
                }
                req.onerror = (e) => {
                    rej(e.target.error)
                }
            })
        }

        del = (id) => {
            var transaction = db.transaction(["investor"], "readwrite");
            var objectStore = transaction.objectStore("investor");
            return new Promise((res, rej) => {
                var req = objectStore.delete(id)
                req.onsuccess = (e) => {
                    res(e.target.result)
                }
                req.onerror = (e) => {
                    rej(e.target.error)
                }
            })
        }

        getAll = () => {
            var transaction = db.transaction(["investor"], "readwrite");
            var objectStore = transaction.objectStore("investor");
            return new Promise((res, rej) => {
                var req = objectStore.getAll()
                req.onsuccess = (e) => {
                    res(e.target.result)
                }
                req.onerror = (e) => {
                    rej(e.target.error)
                }
            })
        }

        dbPromise.then(async d => {
            pGetALl = getAll()
            pGetALl.then(a => {
                if (a) {
                    a.forEach(e => {
                        if (e.id != formatDate(new Date()))
                            del(e.id)
                        else {
                            console.log('Investor Data', e.id)
                        }
                    })
                }
            })

            pget = get(formatDate(new Date()))
            pget.then(d => {
                if (!d) {
                    updateDataTable()
                } else {
                    investorDataStore = d.data;
                    updateDataTable(d.data)
                }
            })
        })


        let vf = (v) => {
            if (v) return v
            else return 0
        }

        let processInvestor = (investorData) => {
            investorDataNew = investorData.map(e => {

                let total_buy = 0;
                let total_sell = 0;
                let total_sell_matched = 0;
                let total_buy_matched = 0;
                Object.keys(e).forEach(k => {
                    if (k.includes('matched')) {
                        if (k.includes('buy')) { total_buy_matched += vf(e[k]) } else { total_sell_matched += vf(e[k]) }
                    } else {
                        if (k.includes('buy') || k.includes('sell'))
                            if (k.includes('buy')) { total_buy += vf(e[k]) } else { total_sell += vf(e[k]) }
                    }

                })
                let local_individual_buy
                let ne = {
                    date: new Date(e.trading_date * 1000 + 7 * 60 * 60 * 1000),
                    code: e.code,
                    total_buy: total_buy,
                    total_sell: total_sell,
                    total_buy_matched: total_buy_matched,
                    total_sell_matched: total_sell_matched,
                    total_sell_remain: (total_sell - total_sell_matched),
                    total_buy_remain: (total_buy - total_buy_matched),
                    ratio_local_individual_buy: (e.local_individual_buy / total_buy * 100),
                    ratio_local_individual_sell: (e.local_individual_sell / total_sell * 100),
                    ratio_local_individual_buy_matched: (e.local_individual_buy_matched / total_buy_matched * 100),
                    ratio_local_individual_sell_matched: (e.local_individual_sell_matched / total_sell_matched * 100),
                    ...e
                }
                return ne;
            })
            let investorDataDays = {}
            investorDataNew.forEach(e => {
                if (!investorDataDays[e.code]) investorDataDays[e.code] = []
                investorDataDays[e.code].push(e)
            })

            let s = Object.keys(investorDataDays);
            s.forEach(e => {
                investorDataDays[e].sort((a, b) => { return b.trading_date - a.trading_date })
            })

            // console.table(investorDataDays['HPG'])

            let days = date.split(',').map(e => +e)
            if (!days.includes(statDay)) { days.push(statDay) }

            let investorDataDaySlide = {}
            s.forEach(e => {
                days.forEach(d => {
                    if (!investorDataDaySlide[e]) investorDataDaySlide[e] = {}
                    investorDataDaySlide[e][d] = investorDataDays[e].slice(0, d)
                })
            })

            let t = {
                total_buy_matched: 0,
                total_sell_matched: 0,
                foreign_buy_matched: 0,
                foreign_sell_matched: 0,
                proprietary_buy_matched: 0,
                proprietary_sell_matched: 0,
                local_individual_buy_matched: 0,
                local_individual_sell_matched: 0,
                local_institutional_buy_matched: 0,
                local_institutional_sell_matched: 0,
                foreign_individual_buy_matched: 0,
                foreign_individual_sell_matched: 0,
                foreign_institutional_buy_matched: 0,
                foreign_institutional_sell_matched: 0,
            }
            let tt2 = {
                total: 0,
                foreign: 0,
                proprietary: 0,
                local_individual: 0,
                local_institutional: 0,
                foreign_individual: 0,
                foreign_institutional: 0,
            }

            let sum = {}
            s.forEach(e => {
                if (!sum[e]) sum[e] = {}
                days.forEach(d => {
                    sum[e][d] = investorDataDaySlide[e][d].reduce((a, b) => {
                        let ret = {}
                        Object.keys(t).forEach(p => {
                            ret[p] = vf(a[p]) + vf(b[p])
                        })
                        return ret;
                    }, { ...t })
                    let delta = {}
                    Object.keys(tt2).forEach(p => {
                        delta[p + "_delta"] = sum[e][d][p + "_buy_matched"] - sum[e][d][p + "_sell_matched"]
                    })
                    sum[e][d] = { ...delta, ...sum[e][d] }
                })

            })

            investorDataNew.forEach((e, i) => {
                let delta = {}
                Object.keys(tt2).forEach(p => {
                    delta[p + "_delta"] = e[p + "_buy_matched"] - e[p + "_sell_matched"]
                })
                investorDataNew[i] = { ...delta, ...e }
            })

            console.table(sum['SSI'][1])
            let sheet = {}
            days.forEach(d => {
                if (!sheet[d]) sheet[d] = []
                s.forEach(e => {
                    sheet[d].push({ code: e, trading_date: investorDataDaySlide[e][d][0].trading_date, date: investorDataDaySlide[e][d][0].date, ...sum[e][d] })
                })
            })

            // console.table(sheet[30][0])
            // console.log(Object.keys(sheet[30][0]))

            return sheet;
        }
    </script>
    <script src="script.js"></script>
</body>

</html>