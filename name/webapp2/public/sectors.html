<!DOCTYPE html>
<html>

<head>
    <title>BuySellSymbols</title>
    <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/dataTables.buttons.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.53/vfs_fonts.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.html5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.print.min.js"></script>
    <!-- <script src="https://cdn.datatables.net/scroller/2.3.0/js/dataTables.scroller.min.js"></script> -->
    <script src="https://cdn.datatables.net/keytable/2.11.0/js/dataTables.keyTable.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.4.2/js/buttons.colVis.min.js"></script>
    <script src="https://cdn.datatables.net/fixedcolumns/4.3.0/js/dataTables.fixedColumns.min.js"></script>
    <script src="https://cdn.datatables.net/fixedheader/3.4.0/js/dataTables.fixedHeader.min.js"></script>


    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/fixedheader/3.4.0/css/fixedHeader.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/fixedcolumns/4.3.0/css/fixedColumns.dataTables.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.7/css/jquery.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/scroller/2.3.0/css/scroller.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/keytable/2.11.0/css/keyTable.dataTables.min.css">
    <link rel="stylesheet" type="text/css"
        href="https://cdn.datatables.net/buttons/2.4.2/css/buttons.dataTables.min.css">


    <script src="https://cdn.socket.io/4.6.0/socket.io.min.js"
        integrity="sha384-c79GN5VsunZvi+Q/WObgk2in0CbZsHnjEqvFxC5DxHn9lTfNce2WW6h2pH6u/kF+"
        crossorigin="anonymous"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numeral.js/2.0.6/numeral.min.js"></script>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }

        table,
        th,
        td {
            border: 1px solid #ccc;
        }

        th,
        td {
            padding: 8px;
            text-align: left;
        }

        th {
            background-color: #f2f2f2;
        }

        #symbolTable {
            margin: 0 auto;
            width: 100%;
            clear: both;
            border-collapse: collapse;
            table-layout: fixed; 
            word-wrap: break-word; 
        }
    </style>
    <style>
        /* CSS for limiting the number of rows and adding a vertical scroll */
        #timelineContainer {
            max-height: 600px;
            /* Set the maximum height for the table */
            overflow-y: auto;
            /* Enable vertical scrolling */
        }
    </style>
    <style>
        /* CSS for enabling both horizontal and vertical scrolling for the entire page */
        body,
        html {
            overflow: scroll;
            /* Enable both horizontal and vertical scrolling for the entire page */
        }
    </style>

</head>

<body>
    <table id="symbolTable" class="display">
        <thead id="symbolHeadTable">
            <tr>
                <th>'Mã'</th>
                <th>' Tên '</th>
                <th>'Thời gian'</th>
                <th>'T'</th>
                <th>'Vol Đặt Mua'</th>
                <th>'Val Đặt Mua'</th>
                <th>'Vol Đặt Bán'</th>
                <th>'Val Đặt Bán'</th>
                <th>'Vol MuaCĐ'</th>
                <th>'Val MuaCĐ'</th>
                <th>'Vol BánCĐ'</th>
                <th>'Val BánCĐ'</th>
                <th>'Vol KoXĐ'</th>
                <th>'Val KoXĐ'</th>
                <th>'Vol Tổng'</th>
                <th>'Val Tổng'</th>
                <th>'Vol Mua-Bán'</th>
                <th>'Val Mua-Bán'</th>
            </tr>
        </thead>
        <tfoot id="symbolFootTable">
            <tr>
                <th>Thống kê</th>
            </tr>
        </tfoot>
        <tbody>
            <!-- Dữ liệu sẽ được thêm ở đây -->
        </tbody>

    </table>

    <table id="symbolChangeTable" class="display">
        <thead id="symbolChangeHeadTable">
            <tr>
                <th>'Mã'</th>
                <th>' Tên '</th>
                <th>'Thời gian'</th>
                <th>'T'</th>
                <th>'Vol Đặt Mua'</th>
                <th>'Val Đặt Mua'</th>
                <th>'Vol Đặt Bán'</th>
                <th>'Val Đặt Bán'</th>
                <th>'Vol MuaCĐ'</th>
                <th>'Val MuaCĐ'</th>
                <th>'Vol BánCĐ'</th>
                <th>'Val BánCĐ'</th>
                <th>'Vol KoXĐ'</th>
                <th>'Val KoXĐ'</th>
                <th>'Vol Tổng'</th>
                <th>'Val Tổng'</th>
                <th>'Vol Mua-Bán'</th>
                <th>'Val Mua-Bán'</th>
            </tr>
        </thead>
        <tfoot id="symbolChangeFootTable">
            <tr>
                <th>Thống kê</th>
                <th></th>
                <th></th>
            </tr>
        </tfoot>
        <tbody>
            <!-- Dữ liệu sẽ được thêm ở đây -->
        </tbody>

    </table>
    <script>
        $.fn.dataTable.ext.errMode = 'none';
        const url = new URL(window.location.href);
        const queryParams = url.searchParams;
        var interval = queryParams.get('interval');
        if (!interval) interval = 60

        let a = new Promise((resolve, reject) => {
            $.ajax({
                url: '/api/getsymbols',
                method: 'GET',
                success: function (response) {
                    resolve(response)
                },
                error: function (error) {
                    console.error('Error fetching updated data:', error);
                }
            });
        })
        a.then(data => {
            // console.table(data)
        })

        // statsHead = document.getElementById('symbolHeadTable');
        // statsHead.innerHTML = ''
        // var theadRow = document.createElement('tr');
        // statsHead.appendChild(theadRow);

        // let label1 = ['Mã', 'Thời gian', 'T', 'Vol Đặt Mua', 'Val Đặt Mua',
        //     'Vol Đặt Bán', 'Val Đặt Bán', 'Vol MuaCĐ', 'Val MuaCĐ', 'Vol BánCĐ', 'Val BánCĐ', 'Vol KoXĐ', 'Val KoXĐ', 'Vol Mua-Bán', 'Val Mua-Bán'
        // ]
        // for (var i = 0; i < label1.length; i++) {
        //     var th = document.createElement('th');
        //     th.textContent = label1[i];
        //     theadRow.appendChild(th);
        // }

        let fields = ["code", "name", "time"
            , "T", "bid_vol", "bid_val", "ask_vol", "ask_val",
            "bu_vol", "bu_val", "sd_vol", "sd_val", "unknown_vol", "unknown_val",
            "total_vol",
            "total_val",
            "busd_vol",
            "busd_val",
        ]

        $('#symbolTable').DataTable(
            {

                ajax: {
                    url: '/api/getsectordata', // Replace with your API endpoint
                    // dataSrc: 'data' // If your data is an array at the root level of the JSON response
                    dataSrc: function (res) {
                        // console.log(res)
                        let data = res.data.map(e => {
                            let v = (v) => {
                                if (v) { return v } else return 0
                            }
                            e["busd_val"] = v(e["bu_val"]) - v(e["sd_val"])
                            e["busd_vol"] = v(e["bu_vol"]) - v(e["sd_vol"])
                            e["total_vol"] = v(e["bu_vol"]) + v(e["sd_vol"]) + v(e["unknown_vol"])
                            e["total_val"] = v(e["bu_val"]) + v(e["sd_val"]) + v(e["unknown_val"])
                            return e;
                        })
                        // data = data.slice(20,21)
                        return data;
                    }
                },
                fixedHeader: {
                    // header: true,
                    // footer: true
                },
                fixedColumns: {
                    left: 1,
                    right: 1
                },
                columns: [
                    ...fields.map(e => { return { data: e, orderable: true } })
                ],
                columnDefs: [
                    { width: 200, targets: 1 },
                    { visible: true, targets: 0 },
                    {
                        targets: [1, 0],
                        render: function (data, type, row, meta) {
                            if (type === 'display') {
                                data = '<a href="timeline?symbols=' + encodeURIComponent(row["code"]) + '"  target="_blank">' + data + '</a>';
                            }
                            return data;
                        }
                    },
                    {
                        targets: Array.from({ length: 14 }, (_, index) => index + 4),
                        render: function (data, type, row, meta) {
                            if (type === 'display') {
                                data = numeral(data).format('0,0');
                            }
                            return data;
                        }
                    },
                    // {
                    //     targets: [3, 4],
                    //     render: function (data, type, row, meta) {
                    //         if (type === 'display') {
                    //             if (Number.isInteger(data)) {
                    //                 data = numeral(data).format('0,0');
                    //             } else {
                    //                 data = numeral(data).format('0,0.00');
                    //             }

                    //         }
                    //         return data;
                    //     }
                    // },
                    // {
                    //     targets: 5,
                    //     render: function (data, type, row, meta) {
                    //         if (type === 'display') {
                    //             data = numeral(data).format('0,0.00');
                    //         }
                    //         return data;
                    //     }
                    // }
                ],

                "rowCallback": function (row, data, index) {
                    if ((data[5] < 0)) {
                        // $(row).css('background-color', 'red');                
                        $('td:eq(5)', row).css('background-color', 'red');
                    }
                    else if ((data[5] > 0)) {
                        // $(row).css('background-color', 'green');
                        $('td:eq(5)', row).css('background-color', 'limegreen');
                    } else {
                        // $(row).css('background-color', 'yellow');
                        $('td:eq(5)', row).css('background-color', 'yellow');
                    }
                },
                processing: true,
                ordering: true,
                scroller: true,
                // scrollY: 200,
                searching: true,
                // serverSide: true,
                lengthMenu: [30, 50, 100, 200, 500, 2000],
                dom: 'lBfrtip',
                buttons: [
                    'copy',
                    // 'csv', 
                    'excel', 'pdf',
                    // 'print', 
                    'colvis'
                ]
                // buttons: [
                //     {
                //         extend: 'copyHtml5',
                //         exportOptions: {
                //             columns: [0, ':visible']
                //         }
                //     },
                //     {
                //         extend: 'excelHtml5',
                //         exportOptions: {
                //             columns: ':visible'
                //         }
                //     },
                //     {
                //         extend: 'pdfHtml5',
                //         exportOptions: {
                //             columns: [0, 1, 2, 5]
                //         }
                //     },
                //     'colvis'
                // ]
            }
        );


        function initSymbolChangeTable(data) {
            $('#symbolChangeTable').DataTable(
                {
                    data: data,
                    fixedHeader: {
                        // header: true,
                        // footer: true
                    },
                    fixedColumns: {
                        left: 1,
                        right: 1
                    },
                    columnDefs: [
                        {
                            targets: 0,
                            render: function (data, type, row, meta) {
                                if (type === 'display') {
                                    data = '<a href="sectortimeline?sectors=' + encodeURIComponent(data) + '"  target="_blank">' + data + '</a>';
                                }
                                return data;
                            }
                        },
                        {
                            targets: Array.from({ length: 14 }, (_, index) => index + 4),
                            render: function (data, type, row, meta) {
                                if (type === 'display') {
                                    data = numeral(data).format('0,0');
                                }
                                return data;
                            }
                        },
                        // {
                        //     targets: [3, 4],
                        //     render: function (data, type, row, meta) {
                        //         if (type === 'display') {
                        //             if (Number.isInteger(data)) {
                        //                 data = numeral(data).format('0,0');
                        //             } else {
                        //                 data = numeral(data).format('0,0.00');
                        //             }

                        //         }
                        //         return data;
                        //     }
                        // },
                        // {
                        //     targets: 5,
                        //     render: function (data, type, row, meta) {
                        //         if (type === 'display') {
                        //             data = numeral(data).format('0,0.00');
                        //         }
                        //         return data;
                        //     }
                        // }
                    ],
                    processing: true,
                    ordering: true,
                    scroller: true,
                    // scrollY: 200,
                    searching: true,
                    // serverSide: true,
                    lengthMenu: [30, 50, 100, 200, 500, 2000],
                    dom: 'lBfrtip',
                    buttons: [
                        'copy',
                        // 'csv', 
                        'excel', 'pdf',
                        // 'print', 
                        'colvis'
                    ]
                    // buttons: [
                    //     {
                    //         extend: 'copyHtml5',
                    //         exportOptions: {
                    //             columns: [0, ':visible']
                    //         }
                    //     },
                    //     {
                    //         extend: 'excelHtml5',
                    //         exportOptions: {
                    //             columns: ':visible'
                    //         }
                    //     },
                    //     {
                    //         extend: 'pdfHtml5',
                    //         exportOptions: {
                    //             columns: [0, 1, 2, 5]
                    //         }
                    //     },
                    //     'colvis'
                    // ]
                }
            );
        }

        let lastSymbolChangeTable = null;
        let lastChange = 0;
        let lastChangeMap = {}
        let keepArray = []
        let timeout = 0;
        let lastMd5 = ''
        let lastAJAX = 0

        $(document).ready(function () {
            // Function to update DataTable
            function updateDataTable() {
                if (Date.now() - lastAJAX <= timeout) {
                    return;
                }

                $.ajax({
                    url: '/api/getsectordata', // Endpoint to get updated data
                    method: 'GET',
                    success: function (response) {
                        var table = $('#symbolTable').DataTable();
                        table.clear();
                        console.table(response.data)
                        let data = response.data.map(e => {
                            let v = (v) => {
                                if (v) { return v } else return 0
                            }
                            e["busd_val"] = v(e["bu_val"]) - v(e["sd_val"])
                            e["busd_vol"] = v(e["bu_vol"]) - v(e["sd_vol"])
                            e["total_vol"] = v(e["bu_vol"]) + v(e["sd_vol"]) + v(e["unknown_vol"])
                            e["total_val"] = v(e["bu_val"]) + v(e["sd_val"]) + v(e["unknown_val"])
                            return e;
                        })

                        table.rows.add(data).draw()
                        // let key = Math.floor(Date.now() / 1000 / interval);
                        // if (!lastChangeMap[key]) {
                        //     lastChangeMap[key] = response.data;
                        //     keepArray.push({ 'key': key, 'data': response.data })
                        //     while (keepArray.length > 2) {
                        //         let out = keepArray.shift();
                        //         delete lastChangeMap[out.key]
                        //     }
                        // }

                        // if (!lastSymbolChangeTable) {
                        //     lastSymbolChangeTable = data;
                        //     lastChange = Date.now()
                        //     initSymbolChangeTable(data)
                        // } else {
                        //     let lastSymbolChangeTable = keepArray[0].data

                        //     var table = $('#symbolChangeTable').DataTable();
                        //     table.clear();
                        //     let c1 = {}
                        //     lastSymbolChangeTable.forEach(e => {
                        //         c1[e[0]] = e
                        //     })
                        //     let c2 = {}
                        //     response.data.forEach(e => {
                        //         let a = []
                        //         e1 = c1[e[0]]
                        //         if (e1) { //Neu co thi tinh sai biet
                        //             e.forEach((v, i) => {
                        //                 if (i <= 5) a[i] = v
                        //                 else {
                        //                     // a[i] = numeral(v - e1[i]).format('0,0')
                        //                     a[i] = v - e1[i]
                        //                 }
                        //             });
                        //         } else { //Neu khong co thi tinh theo moi nhat
                        //             a = e;
                        //         }

                        //         let t = a[10] + a[12] + a[14]
                        //         let tv = a[11] + a[13] + a[15]
                        //         a = [...a.slice(0, a.length - 2), t, tv, a.at(-2), a.at(-1)]
                        //         a.forEach((v, i) => {
                        //             if (i >= 6) a[i] = numeral(v).format('0,0')
                        //         })
                        //         c2[e[0]] = a

                        //         // if (e[0] == 'DXG') console.table({ 'a': a, 'e1': e1, 'e': e })
                        //     })
                        //     table.rows.add(Object.values(c2)).draw()
                        // }

                        lastAJAX = Date.now()
                        if (lastMd5 == response.md5) {
                            timeout += 1000
                            if (timeout >= 10000) {
                                timeout = 10000;
                                console.log('Timeout ', timeout, 'md5', response.md5)
                            }
                        } else {
                            timeout = 0;
                        }
                        // console.table(response)
                        lastMd5 = response.md5

                    },
                    error: function (error) {
                        console.error('Error fetching updated data:', error);
                    }
                });
            }

            // Update DataTable every 5 seconds (adjust as needed)
            setInterval(updateDataTable, 1000);
        });
    </script>
</body>

</html>